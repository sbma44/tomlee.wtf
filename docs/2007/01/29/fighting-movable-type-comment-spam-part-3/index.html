<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>fighting movable type comment spam - part 3 - Tom Lee</title>

    <meta name="description" content="We've made some good progress. In part one I talked about how comment spammers operate and some theoretical ways to stop them. In part two I...">
    <meta name="robots" content="noindex, nofollow">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;600;700&family=Josefin+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="https://tomlee.wtf/theme/css/style.css">

    <link href="https://tomlee.wtf/feed.xml" type="application/atom+xml" rel="alternate" title="Tom Lee Atom Feed" />

    <script data-host="https://app.microanalytics.io" data-dnt="false" src="https://app.microanalytics.io/js/script.js" id="ZwSg9rf6GA" async defer></script>

</head>

<body>
    <header id="typology-header" class="typology-header">
        <div class="container">
            <div class="header-content">
                <div class="site-branding">
                    <h1 class="site-title"><a href="https://tomlee.wtf/">Tom Lee</a></h1>
                </div>
                <nav class="main-nav">
                    <ul>
                        <!-- <li><a href="https://tomlee.wtf/">Home</a></li>
                        <li><a href="https://tomlee.wtf/about/">About</a></li>
                        <li><a href="https://tomlee.wtf/projects/">Projects</a></li> -->
                        <li class="social-icon"><a href="https://github.com/sbma44" target="_blank" rel="noopener" title="GitHub" aria-label="GitHub">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        </a></li>
                        <li class="social-icon"><a href="https://x.com/tjl" target="_blank" rel="noopener" title="Twitter" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                        </a></li>
                        <li class="social-icon"><a href="https://bsky.app/profile/tjl.bsky.social" target="_blank" rel="noopener" title="Bluesky" aria-label="Bluesky">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8z"/></svg>
                        </a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="typology-fake-bg">
<div class="typology-section">
    <div class="section-content">
        <article class="typology-post typology-single-post">
            <header class="entry-header">
                <h1 class="entry-title">fighting movable type comment spam - part 3</h1>

                <div class="entry-meta">
                    <span class="meta-item">
                        <time datetime="2007-01-29T00:16:00-05:00">Monday, 29 January 2007</time>
                    </span>
                </div>

                <div class="post-letter">F</div>
            </header>

            <div class="entry-content">
                <p>We've made some good progress. In <a class="reference external" href="/2007/01/26/fighting-movable-type-comment-spam-part-1/">part one</a> I talked about how comment spammers operate and some theoretical ways to stop them. In <a class="reference external" href="/2007/01/26/fighting-movable-type-comment-spam-part-1/">part two</a> I offered a little more practical advice, providing a walkthrough on how to convert an MT site from static HTML pages to PHP and offering more specific instructions on how to hide where your comment script lives. I know that at least one person has seen a reduction in comment spam as a result, which makes me pretty pleased.</p>
<p>Sadly, what we've covered so far isn't enough. Spammers will find your renamed mt-comments.cgi no matter how much Javascript you bury it under. If users can use the form, so can spammers. They'll find the new location of mt-comments.cgi sooner or later, and then we'll be back at square one.</p>
<p>But what if mt-comments kept changing its location? We can write a script that renames the file every time it runs, then set it to run at a regular interval. That way even when a spammer manages to find it they'll only be able to send spam until the next time the script runs. It'll be great! There are a couple of problems with this approach, though:</p>
<ol class="arabic">
<li><p class="first">If the script runs while a user is composing a comment, when they hit submit the form will send its data to a version of mt-comments that no longer exists. That could be a major pain in the ass. Fortunately, there's a pretty simple solution: we'll just keep two copies of mt-comments around at a time, deleting old ones and adding new ones on a rolling basis. That way a user would have to keep their browser open for two script-intervals in order for their comment to be lost.</p>
</li>
<li><div class="first line-block">
<div class="line">The bigger problem is how to let the site's comment forms know about the changing location of mt-comments.cgi. You might recall that Movable Type sticks these values into its templates with code that looks like this:</div>
</div>
<blockquote>
<pre class="literal-block">
action=&quot;&lt;$MTCGIPath$&gt;&lt;$MTCommentScript$&gt;&quot;
</pre>
</blockquote>
<div class="line-block">
<div class="line">That's fine in theory, but in practice it doesn't work out very well. That's because in order to update those values, Movable Type requires that you rebuild the site. That means we'd be recomposing every page on the blog every time the mt-comments script was renamed. Users wouldn't like the slowdown, and your webhost would get upset about the system resources that you'd end up hogging.</div>
<div class="line">So instead we'll drop the &lt;$MTCGIPath$&gt;&lt;$MTCommentScript$&gt; nonsense and just use some PHP. That'll let us keep track of the mt-comments script in a single PHP file. When a comment form is loaded it'll read the file and use whatever it finds there. It'll be plenty fast and it won't require that any pages be rebuilt.</div>
</div>
</li>
</ol>
<p>So here's the script:</p>
<blockquote>
<pre class="literal-block">
&lt;?php
// CONFIGURATION
$SECRET = 'mysecret';
$MT_DIRECTORY = '/public_html/mt/';
$WRITEABLE_DIRECTORY = '/tmp/';
$ftp_info = array(
'host' =&gt; 'ftp.yourwebhost.com',
'user' =&gt; 'your_login',
'password' =&gt; 'your_password',
'port' =&gt; 21
);
// END CONFIGURATION
if(isset($_GET[$SECRET])):
// login, get mt-config.cgi
$ftp = ftp_connect($ftp_info['host'],$ftp_info['port']) or die('Couldn\'t connect to FTP service.  Is your FTP info correct?');
ftp_login($ftp,$ftp_info['user'],$ftp_info['password']);
ftp_chdir($ftp,$MT_DIRECTORY);
ftp_get($ftp,$WRITEABLE_DIRECTORY . 'mt-config.cgi','mt-config.cgi',FTP_ASCII);
// retrieve the config file
$handle = fopen($WRITEABLE_DIRECTORY . 'mt-config.cgi','r');
$mt_config = fread($handle, filesize($WRITEABLE_DIRECTORY . 'mt-config.cgi'));
fclose($handle);
// split it up, process each line
$mt_config = split(&quot;\n&quot;,$mt_config);
$new_mt_config = '';
$comment_script_current = 'mt-comments.cgi';
$comment_script_old = 'mt-comments-old.cgi';
$mt_cgipath = '';
foreach($mt_config as $line)
{
$line = trim($line);
if(preg_match('/^\s*CommentScript\s+(.*)/i',$line,$matches))
$comment_script_current = $matches[1];
elseif(preg_match('/^\s*#\s*OldCommentScript\s+(.*)/i',$line,$matches))
$comment_script_old = $matches[1];
elseif(!preg_match('/##### Added by mt\-rotate\.php #####/i',$line))
{
if(preg_match('/^\s*CGIPath\s+(.*)/i',$line,$matches))
{
$mt_cgipath = $matches[1];
if(substr($mt_cgipath,-1)!='/')
$mt_cgipath .= '/';
}
$new_mt_config .= $line . &quot;\r\n&quot;;
}
}
$new_mt_config = trim($new_mt_config); // get rid of trailing newline chars
// get mt-comments.cgi
ftp_get($ftp,$WRITEABLE_DIRECTORY . $comment_script_current,$comment_script_current,FTP_ASCII);
// generate a new name for mt-comments.cgi (20 chars, a-z, upper &amp; lower case)
$comment_script_new = '';
while(strlen($comment_script_new)&lt;20)
{
$newchar = chr(ord('a') + rand(0,25));
$comment_script_new .= (((rand()%2)==0) ? $newchar : strtoupper($newchar));
}
$comment_script_new .= '.cgi';
// rename the current comment script
rename($WRITEABLE_DIRECTORY . $comment_script_current, $WRITEABLE_DIRECTORY . $comment_script_new);
// rewrite mt-config.cgi
$new_mt_config .= &quot;\r\n\r\n##### Added by mt-rotate.php #####\r\n&quot;;
$new_mt_config .= &quot;CommentScript $comment_script_new\r\n&quot;;
$new_mt_config .= &quot;# OldCommentScript $comment_script_current\r\n&quot;;
$handle = fopen($WRITEABLE_DIRECTORY . 'mt-config.cgi', 'w');
fwrite($handle,$new_mt_config);
fclose($handle);
// rewrite the PHP include
$php_include = &quot;&lt;?php \$PATH_TO_MT_COMMENTS = '&quot; . $mt_cgipath . $comment_script_new . &quot;'; ?&gt;&quot;;
$handle = fopen($WRITEABLE_DIRECTORY . 'mt-comments-location.php','w');
fwrite($handle,$php_include);
fclose($handle);
// upload the new mt-config.cgi
ftp_put($ftp,'mt-config.cgi',$WRITEABLE_DIRECTORY . 'mt-config.cgi',FTP_ASCII);
// upload the new comment script and set its permissions
ftp_put($ftp,$comment_script_new,$WRITEABLE_DIRECTORY . $comment_script_new,FTP_ASCII);
ftp_site($ftp,&quot;CHMOD 0755 $comment_script_new&quot;);
// delete the old comment script
ftp_delete($ftp,$comment_script_old);
// upload mt-comments-location.php
ftp_put($ftp,'mt-comments-location.php',$WRITEABLE_DIRECTORY . 'mt-comments-location.php',FTP_ASCII);
ftp_close($ftp);
// clean up the temp directory
unlink($WRITEABLE_DIRECTORY . $comment_script_new);
unlink($WRITEABLE_DIRECTORY . 'mt-config.cgi');
unlink($WRITEABLE_DIRECTORY . 'mt-comments-location.php');
endif;
?&gt;
</pre>
</blockquote>
<p>You'll notice that there's a bunch of info to fill in at the top. Most of it should be pretty straightforward. You'll need the FTP info for your webhost account — even though we'll run the script on the same machine as your blog, it needs to connect to itself by FTP in order to make sure that the permissions on the files can be set correctly.</p>
<p>The $WRITEABLE_DIRECTORY value can probably be ignored — /tmp/ should work on pretty much every webhost out there. If it doesn't work, you can just create a directory with permissions set to 777 somewhere and point the script at it. But mostly, don't worry about it.</p>
<p>The $MT_DIRECTORY variable needs to point at the directory where Movable Type is installed, and needs to do so from an FTP client's perspective. Connect to your site with an FTP client and browse to your MT directory. You should be able to figure it out from there.</p>
<p>Finally, $SECRET should be set to a unique string. No weird characters or spaces, either — this needs to be able to be added to a URL, so stick to a simple alphanumeric password. This is necessary because running the script too often could constitute a denial-of-service attack on your blog, effectively making it impossible for anyone to comment. Putting a password in a querystring is generally a terrible idea, but since the requests for this script won't be going out over the internet (or outside the host machine at all) it should probably be okay.</p>
<p>Once you've set all of those values, save the script as <strong>mt-rotate.php</strong> and upload it to the directory where Movable Type is installed (i.e. the one where mt.cgi and mt-config.cgi live). Now it's ready to be tested. Fire up your browser and head to:</p>
<blockquote>
<a class="reference external" href="http://www.yourdomain.com/mt/mt-rotate.php?mysecret">http://www.yourdomain.com/mt/mt-rotate.php?mysecret</a></blockquote>
<p>Of course, change the path so that you're pointing at the right domain and the correct directory. And change &quot;mysecret&quot; to match whatever you set the $SECRET variable to in the script. If all goes well you shouldn't see anything at all — FTP into the site, check the Movable Type directory and confirm that it now has a file called mt-comments-location.php in it, that there's a file with a gibberish name (but ending in .cgi) and that mt-config.cgi now has a line at the bottom mentioning mt-rotate.php. If instead of all of this you see error messages in your web browser, well, something's wrong. Leave a comment and we'll sort it out.</p>
<p>So we can now rotate our comment script's filename every time we call this particular URL. And the new, secret name of the file is kept in mt-comments-location.php in the MT directory. Now we just need to adjust our comment forms so that they can use that PHP file, then set the mt-rotate script to run on an automatic basis.</p>
<p>In order to use mt-comments-location.php, we'll need to know where it resides. Unfortunately, that might be a problem. The $MT_DIRECTORY value may or may not match up with the full path to this file; it all depends on your webhost. I've put together a little script to make it easier to figure out. Download <a class="reference external" href="/static/2007/01/29/where-am-i.php.txt">this</a>, rename it to where-am-i.php (take the .txt off the end) and upload it to the MT directory on the server. Load it up in your web browser (<a class="reference external" href="http://www.yourserver.com/path/to/mt/where-am-i.php">http://www.yourserver.com/path/to/mt/where-am-i.php</a>) and have a look at the output. It ought to tell you what the filesystem path to the MT directory is.</p>
<p>So! You now have the information necessary to rewrite your comment form's <em>action</em> property on the fly. If you didn't add the Javascript obfuscation from <a class="reference external" href="/2007/01/26/fighting-movable-type-comment-spam-part-1/">part two</a>, your comment form tag should still look something like this:</p>
<blockquote>
<pre class="literal-block">
&lt;form method=&quot;post&quot; action=&quot;&lt;$MTCGIPath$&gt;&lt;$MTCommentScript$&gt;&quot; name=&quot;comments_form&quot; onsubmit=&quot;if (this.bakecookie.checked) rememberMe(this)&quot;&gt;
</pre>
</blockquote>
<p>You'll need to add a PHP include statement, then some code to use the variable that becomes available by virtue of the include. Use this, but replace the /path/to/mt/ with the correct filesystem path where Movable Type resides:</p>
<blockquote>
<pre class="literal-block">
&lt;?php include('/path/to/mt/mt-comments-location.php');?&gt;
&lt;form method=&quot;post&quot; action=&quot;&lt;php print $PATH_TO_MT_COMMENTS;$&gt;&quot; name=&quot;comments_form&quot; onsubmit=&quot;if (this.bakecookie.checked) rememberMe(this)&quot;&gt;
</pre>
</blockquote>
<p>If you <em>did</em> implement the Javascript obfuscation, you'll just want to swap &lt;$MTCGIPath$&gt;&lt;$MTCommentScript$&gt; and replace it with $PATH_TO_MT_COMMENTS. Like so:</p>
<blockquote>
<pre class="literal-block">
&lt;?php include('/path/to/mt/mt-comments-location.php');?&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
&lt;?php print ObfuscateJS(&quot;document.comments_form.action = '$PATH_TO_MT_COMMENTS';&quot;);?&gt;
&lt;/script&gt;
</pre>
</blockquote>
<p>Make this change in all the templates that have a comment form in them, then rebuild your site (or just open and re-save one entry, if you'd prefer to make sure things are working before rebuilding all of your site's comment forms). If your comment form seems to be working, you're in great shape. If you see PHP warning messages showing up on the page around where you added the <em>include()</em> statement, odds are that you got the path to mt-comments-location.php wrong.</p>
<p>But let's say that you didn't. You're pretty much all set — all you need to do is call the script on a regular basis.</p>
<p>The way to do this is with a cron job — these are tasks that can be scheduled to occur at regular intervals on a Unix-style system. You should be able to set up a cron job through your web host's control panel software. This is where you manage the domain's email addresses, among other things. It can vary between hosts, but if you look for &quot;cron jobs&quot; or &quot;scheduled tasks&quot; you should probably be able to find it.</p>
<p>cPanel is probably the most popular of these kinds of control panel software packages, and it happens to be what my webhost uses. So let's have a look at how to make it work:</p>
<div class="line-block">
<div class="line"><a class="reference external image-reference" href="http://www.flickr.com/photo_zoom.gne?id=372926381&amp;size=o"><img alt="finding the cron item in cPanel" src="http://farm1.static.flickr.com/129/372926381_a4cadcd99f_t.jpg" /></a></div>
<div class="line"><a class="reference external image-reference" href="http://www.flickr.com/photo_zoom.gne?id=372926312&amp;size=o"><img alt="selecting the standard cron mode" src="http://farm1.static.flickr.com/127/372926312_c33ec4d09b_t.jpg" /></a></div>
<div class="line"><a class="reference external image-reference" href="http://www.flickr.com/photo_zoom.gne?id=372926431&amp;size=o"><img alt="here's the punchline" src="http://farm1.static.flickr.com/156/372926431_64a05725d4_t.jpg" /></a></div>
</div>
<p>It ought to be relatively self-explanatory, particularly if you have a look at the above screenshots. But here's the punchline, the command that you want to run every time the cron does:</p>
<blockquote>
<pre class="literal-block">
wget http://manifestdensity.net/mt/mt-rotate.php?mysecret -O/dev/null
</pre>
</blockquote>
<div class="line-block">
<div class="line">&quot;wget&quot; is a program that fetches webpages. The first parameter specifies the URL we want it to fetch (be sure to replace</div>
<div class="line">&quot;mysecret&quot; with a real value). And the second says to send the retrieved HTML staight to the trash (otherwise it might generate a bunch of junk files in some directory or another). We don't need to hang onto the output, anyway — it's the incoming request that triggers the script's actions. The HTML it produces (or doesn't in this case — remember, there should be no output if it works right) is irrelevant except for debugging purposes.</div>
</div>
<p>And, with that somewhat anticlimactic final step, we should be done. The cron should fire however often you set it to (as you can see from the screenshot, I told it to fire once an hour — that seems like a good number to me). When it does, the necessary files will be renamed and updated, and your Movable Type installation should remain fairly spam-free. Hurrah!</p>
<p><strong>UPDATE:</strong> Whoops! My mistake: I didn't realize that the comment preview template can't be made to use PHP — the filename will always end in .cgi, because it *is* the mt-comments script. You might have noticed this when you implemented part two and ended up with non-working Javascript.</p>
<p>The good news is that there's an easy workaround: <strong>simply remove the action attribute from the comment preview template's form tag entirely</strong>. This will make the form submit to itself. If someone's at the preview form, they already know the URL, which means they have the comment script name and there's no point in hiding it anyway.</p>

            </div>

        </article>
    </div>
</div>
    </div>

    <footer id="typology-footer" class="typology-footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy;  Tom Lee</p>
                <!-- <p>Powered by <a href="https://getpelican.com/" target="_blank" rel="noopener">Pelican</a></p> -->
            </div>
        </div>
    </footer>
</body>
</html>