<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>hype/m: revivified, then vivisected - Tom Lee</title>

    <meta name="description" content="There's a new version of the Hy/pe Mac/hine! Cool. The mp3 blog aggregator's gotten a new coat of paint and a different flash player. It looks...">
    <meta name="robots" content="noindex, nofollow">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;600;700&family=Josefin+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="/theme/css/style.css">

    <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Tom Lee Atom Feed" />

</head>

<body>
    <header id="typology-header" class="typology-header">
        <div class="container">
            <div class="header-content">
                <div class="site-branding">
                    <h1 class="site-title"><a href="/">Tom Lee</a></h1>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/about/">About</a></li>
                        <li><a href="/projects/">Projects</a></li>
                        <li class="social-icon"><a href="https://github.com/sbma44" target="_blank" rel="noopener" title="GitHub" aria-label="GitHub">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        </a></li>
                        <li class="social-icon"><a href="https://x.com/tjl" target="_blank" rel="noopener" title="Twitter" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                        </a></li>
                        <li class="social-icon"><a href="https://bsky.app/profile/tjl.bsky.social" target="_blank" rel="noopener" title="Bluesky" aria-label="Bluesky">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8z"/></svg>
                        </a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="typology-fake-bg">
<div class="typology-section">
    <div class="section-content">
        <article class="typology-post typology-single-post">
            <header class="entry-header">
                <h1 class="entry-title">hype/m: revivified, then vivisected</h1>

                <div class="entry-meta">
                    <span class="meta-item">
                        <time datetime="2007-10-16T14:49:00-04:00">Tuesday, 16 October 2007</time>
                    </span>
                </div>

                <div class="post-letter">H</div>
            </header>

            <div class="entry-content">
                <p>There's a new version of the Hy/pe Mac/hine! Cool. The mp3 blog aggregator's gotten a new coat of paint and a different flash player. It looks pretty nice, although I'm not entirely sure what substantive changes have been made. Nevertheless, it's at least much more t-shirt-compatible.</p>
<p>I decided to celebrate the occasion by digging into the workings of the site a bit more. Hype/m provides a lot of music but is understandably hesitant to provide direct downloads lest they be busted by The Man. But how do you go about providing an mp3 for listening but not for saving? It's as fundamentally unsolvable as any other DRM problem — more so, given the relatively open technologies that the site uses.</p>
<p>Still, they do their best. For instance, only requests from known web browsers are allowed — try to use a command-line tool like wget or curl to fetch content and you'll get an ACCESS DENIED message. But it's easy to fake user agent strings (or just to do the dirty work within your browser). Consequently, this isn't the only security that the site employs.</p>
<p>Let's have a look at the anatomy of playing a song on hypem:</p>
<ol class="arabic">
<li><p class="first">You click the play button next to a track.</p>
</li>
<li><div class="first line-block">
<div class="line">An AJAX request is sent that looks something like this:</div>
</div>
<blockquote>
<p><a class="reference external" href="http://hypem.com/inc/serve_nowplaying.php?id=">http://hypem.com/inc/serve_nowplaying.php?id=</a><strong>401678_1</strong></p>
</blockquote>
<p>The part in bold is an identifier that's unique to the song you requested.</p>
</li>
<li><div class="first line-block">
<div class="line">Some HTML is sent back and placed in the portion of the page where the play button used to live. It looks like this:</div>
</div>
<blockquote>
<pre class="literal-block">
&lt;object class=&quot;play&quot; classid=&quot;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&quot; codebase=&quot;http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0&quot; width=&quot;36&quot; height=&quot;18&quot;&gt;
&lt;param name=&quot;movie&quot; value=&quot;http://hypem.com/h2p.swf?autoplay=true&amp;url=N2NjZGZkYTJkMjc0ZTZmNGY3OTVmNmQ0Mzg4MTEzYTVjMTgyM2NhY2ZmYzI2ZTAyMzE2MGIwMDY1NjJmOTA5MTJlMzE1ODA5MzYyYzBjODJiYjdjODBhNGI0ZDIwODkyMDRhNTQ3M2U4OWQwOGE2Mjk5YjQ1MWRjMjk1ZjFkNTlmYmIyZWIwZmU5YThlMDU1&quot;&gt;
&lt;param name=&quot;wmode&quot; value=&quot;transparent&quot;&gt;
&lt;param name=&quot;quality&quot; value=&quot;high&quot;&gt;
&lt;embed src=&quot;http://hypem.com/h2p.swf?autoplay=true&amp;url=N2NjZGZkYTJkMjc0ZTZmNGY3OTVmNmQ0Mzg4MTEzYTVjMTgyM2NhY2ZmYzI2ZTAyMzE2MGIwMDY1NjJmOTA5MTJlMzE1ODA5MzYyYzBjODJiYjdjODBhNGI0ZDIwODkyMDRhNTQ3M2U4OWQwOGE2Mjk5YjQ1MWRjMjk1ZjFkNTlmYmIyZWIwZmU5YThlMDU1&quot; quality=&quot;high&quot; wmode=&quot;transparent&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot; type=&quot;application/x-shockwave-flash&quot; width=&quot;36&quot; height=&quot;18&quot;&gt;&lt;/embed&gt;
&lt;/object&gt;
</pre>
</blockquote>
<p>This code tells the browser to load an Adobe Flash object called <em>h2p.swf</em> and pass it parameters telling it A) to start playing immediately (<em>autoplay=1</em>) and B) where to find the mp3 that it should play. This is accomplished via a mysterious <em>url</em> parameter, which I've highlighted in bold in the HTML above.</p>
</li>
<li><div class="first line-block">
<div class="line">Using the <a class="reference external" href="http://livehttpheaders.mozdev.org/">LiveHTTPHeaders</a> plugin for Firefox, we can see that the flash video then requests a file named something like:</div>
</div>
<blockquote>
<p><a class="reference external" href="http://hypem.com/serve/f/509/401678/f48c7f07a821a8fc528842d0bd8d3029.mp3">http://hypem.com/serve/f/509/401678/f48c7f07a821a8fc528842d0bd8d3029.mp3</a></p>
</blockquote>
<p>That's straightforward enough. But how does it get that long URL from the even-longer <em>url</em> querystring parameter that's passed to the Flash movie?</p>
</li>
</ol>
<p>To find out, we've got to take a look inside the seemingly black box of the flash movie. Fortunately there's a great tool that lets us do that: <a class="reference external" href="http://www.nowrap.de/flare.html">Flare</a>, which is free, cross-platform, and will happily extract the ActionScript from a Flash movie. I grabbed the h2p.swf file and passed it to Flare. Here's the interesting part of what I got back:</p>
<blockquote>
<pre class="literal-block">
this.m = new mp(this, com.meychi.ascrypt.RC4.decrypt(com.meychi.ascrypt.Base64.decode(_root.url), 'abcdef1234567890'));
</pre>
</blockquote>
<p>Hello there... looks an awful lot like a decryption routine... and something that looks suspiciously like a decryption key! This line takes the aforementioned <em>url</em> querystring parameter, Base64-decodes it, then passes it to an RC4 decryption routine along with the decryption key <em>abcdef1234567890</em> (not the actual key). This turns the <em>url</em> parameter into a usable URL, which the flash player then fetches.</p>
<p>The meychi.ascrypt library's website is offline, but a little digging into its code (also returned by Flare) shows that, unlike most RC4 decryption libraries, it expects to receive a string of hexadecimal bytes which it first converts into a string of chars before applying the RC4 decryption algorithm. The need for this extra step had me scratching my head for a while, but eventually I figured out what was going on and cobbled together the following script to replicate the functionality. It's in Perl, since I couldn't find any RC4 routines in Ruby.</p>
<blockquote>
<pre class="literal-block">
#!/usr/bin/perl
use MIME::Base64;
use Crypt::RC4;
# hype mac/hine's secret encryption cipher... shhh!
$passphrase = 'abcdef1234567890';
if($src = &lt;&gt;)
{
# decode the URL-safe parameter from base64
$unencoded_src = decode_base64($src);
# convert decoded input from hexadecimal bytes to a string of chars
$charred_ciphertext = '';
while(length($unencoded_src)&gt;0)
{
$char = substr($unencoded_src, 0, 2);
$charred_ciphertext .= chr(hex($char));
$unencoded_src = substr($unencoded_src,2);
}
# decrypt with RC4 algorithm
print RC4($passphrase,$charred_ciphertext);
}
</pre>
</blockquote>
<p>Pipe the <em>url</em> querystring parameter to that script and it'll spit out the URL of the actual file. Paste that into your browser and you'll be redirected to the file's actual location — your browser will begin downloading it quite happily.</p>
<p>Of course, this is all kind of a huge pain in the ass. It's much easier to follow the link to the blog where hype/m first found the mp3 and keep your fingers crossed that the original link is still alive. But! If you could just find Javascript libraries for <a class="reference external" href="http://www.webtoolkit.info/javascript-base64.html">Base64 encoding</a> and <a class="reference external" href="http://home.versatel.nl/MAvanEverdingen/Code/">RC4 decryption</a> you could make a bookmarklet or Greasemonkey script that automatically adds a direct download link to every hype/m entry. Hmmmmm.</p>
<p>Anyway, I should probably finish by saying that none of this should be taken as an indictment of the hype/m programmers' skills. The Hype Ma/chine is a truly impressive piece of software, and the countermeasures its creators have implemented to prevent direct downloading are pretty much everything I can think of doing. The problem is simply that allowing a user to hear content but not store it is an impossible task. And keeping secrets hidden in Flash — which is the only appropriate technology for this application — is similarly impossible, making whatever obfuscation they employ relatively easy to unravel.</p>
<p>The only improvement I can think to make would be to rotate encryption keys by serving a variety of different player SWFs, and invalidating an mp3's URL as soon as an incorrect key is used (I assume that the URLs produced by my script are temporary redirects that rotate fairly frequently and can be expired as necessary). This way a user couldn't cycle through the known keys. As far as I know, decompiling an SWF is not something that can be accomplished in Javascript.</p>
<p>But it probably <em>could</em> be done within a full-on Firefox plugin. And given browsers' enthusiasm for caching Flash (and Javascript's ability to easily differentiate SWFs with different names), the above proposal might not be a viable approach at all. Really, there's no way to completely secure this system. &quot;Good enough&quot; is all that one can reasonably hope for, and I think they've already achieved that.</p>
<p><em>Cross-posted at</em> <a class="reference external" href="http://labs.echoditto.com/hypem">EchoDitto Labs</a></p>

            </div>

        </article>
    </div>
</div>
    </div>

    <footer id="typology-footer" class="typology-footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy;  Tom Lee</p>
                <!-- <p>Powered by <a href="https://getpelican.com/" target="_blank" rel="noopener">Pelican</a></p> -->
            </div>
        </div>
    </footer>
</body>
</html>