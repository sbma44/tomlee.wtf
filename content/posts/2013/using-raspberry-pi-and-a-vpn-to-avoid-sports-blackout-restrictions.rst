using Raspberry Pi and a VPN to avoid sports blackout restrictions
##################################################################
:date: 2013-12-01 14:56
:author: admin
:category: Uncategorized
:slug: using-raspberry-pi-and-a-vpn-to-avoid-sports-blackout-restrictions
:status: published
:save_as: 2013/12/01/using-raspberry-pi-and-a-vpn-to-avoid-sports-blackout-restrictions/index.html
:url: 2013/12/01/using-raspberry-pi-and-a-vpn-to-avoid-sports-blackout-restrictions/
:private: true

Broadcast sports is finally, finally embracing the digital age. My Apple TV has separate apps for the NHL, NBA and MLB, for instance. Sadly, these are still subject to blackout restrictions, preventing me from being able to purchase Capitals games. Irritating!

As it happens, I have a pay-as-you-go account with IPredator, a Swedish VPN service. For a few bucks a month, they provide the ability to use a high-bandwidth encrypted link that terminates your internet traffic in Sweden. I mostly use this for Bittorrent (though pretty rarely, believe it or not). But I figured it might let me get around blackout rules, too.

Unfortunately, the Apple TV isn't able to use VPN software. So we need something to handle that operation instead, making the Apple TV think that it's on a perfectly normal network -- albeit one in Sweden.

This had been on my to-do list for a while, but I finally got around to tackling it today. The results are pretty good! Sadly, it appears that `hockey-crazy Sweden has blackout rules of its own <http://www.nhl.com/ice/gclfaq.htm>`__ -- presumably the NHL has a distribution deal with some broadcaster there that makes it necessary to confound people like myself who want to pay to watch hockey but don't care to pay for a complete cable TV package. Bah.

But the system is working -- a laptop substituted for the Apple TV is convinced it's sitting in Stockholm, and my Apple TV Netflix experience is substantially different (title availability is wildly altered). And the NBA League Pass stuff looks like it might be working fine (I don't have an account, but will be bugging Matt to try his out shortly).

So I'll go ahead and record what I did here before I forget it. Perhaps before too long I'll switch to a VPN that terminates in a (non-Washington) US city and see if that doesn't solve my problems.

.. raw:: html

   <ol>

.. raw:: html

   <li>

Buy a `Raspberry Pi <http://www.raspberrypi.org/>`__ Model B (the one with the on-board ethernet jack). Get the basic Raspbian distro up and running.

.. raw:: html

   </li>

.. raw:: html

   <li>

Add a `USB ethernet adapter <http://www.amazon.com/Crest-SY-ADA24005-USB-Ethernet-Adapter/dp/B003M8I0RM/ref=sr_1_8?ie=UTF8&qid=1385926903&sr=8-8&keywords=usb+ethernet>`__ -- one with Linux support. Note that I haven't tried the one at that link, but it claims to be Linux-friendly. I've been using an overpriced Apple adapter.

.. raw:: html

   </li>

.. raw:: html

   <li>

The USB ethernet port is eth1, and will be what you plug your Apple TV/whatever into. The on-board Raspberry Pi ethernet port is eth0, and should be connected to your router.

.. raw:: html

   </li>

.. raw:: html

   <li>

Follow `LadyAda's instructions for making your Raspberry Pi into a wifi access point <http://learn.adafruit.com/setting-up-a-raspberry-pi-as-a-wifi-access-point/install-software>`__ -- except skip everything that has to do with hostapd or iptables. Also, replace references to "wlan0" with "eth1". After rebooting, you should now be able to plug a computer into the USB adapter via ethernet and receive an IP address that begins with 192.168.42. If you can't, something is wrong.

.. raw:: html

   </li>

.. raw:: html

   <li>

`Configure OpenVPN for IPredator using their Debian setup instructions <https://www.ipredator.se/guide/openvpn/debian/native>`__. When running, this creates a virtual network adapter called tun0 -- it's quite similar to eth0 or eth1 (the ethernet cards) except it's a software abstraction. Also, configure this to start up automatically -- the IPredator instructions gloss over this. It shouldn't take more than a "sudo update-rc.d openvpn enable".

.. raw:: html

   </li>

.. raw:: html

   <li>

| Use the following iptables configuration to make the Raspberry Pi act as a router that sends incoming traffic to tun0:

   | # Generated by iptables-save v1.4.14 on Sun Dec 1 13:49:10 2013
   | \*nat
   | :PREROUTING ACCEPT [329:25039]
   | :INPUT ACCEPT [194:13371]
   | :OUTPUT ACCEPT [0:0]
   | :POSTROUTING ACCEPT [0:0]
   | -A POSTROUTING -o tun0 -j MASQUERADE
   | COMMIT
   | # Completed on Sun Dec 1 13:49:10 2013
   | # Generated by iptables-save v1.4.14 on Sun Dec 1 13:49:10 2013
   | \*filter
   | :INPUT ACCEPT [1384:725715]
   | :FORWARD ACCEPT [877:601931]
   | :OUTPUT ACCEPT [1102:200985]
   | -A FORWARD -i eth1 -j ACCEPT
   | COMMIT
   | # Completed on Sun Dec 1 13:49:10 2013

You can grab the gist `here <https://gist.github.com/sbma44/7739920>`__. Save this into /etc/iptables.up.rules then create a file called /etc/network/if-pre-up.d/iptables that contains the following:

   | #!/bin/bash
   | /sbin/iptables-restore < /etc/iptables.up.rules

Give it a good "sudo chmod +x /etc/network/if-pre-up.d/iptables" to make it executable and, if all has gone well, you're done! You now have a Raspberry Pi that lets network traffic go in one end and emerge in Sweden. Kinda neat.
